# Techrater HTTP API

## Hosts

- `cafuuchino1.3322.org:10026`
- `cafuuchino2.3322.org:10026`
- `cafuuchino3.3322.org:10026`
- `cafuuchino4.3322.org:10026`
- `cafuuchino5.3322.org:10026`

## Base Path

`/techmino/api/v1`

## Failed Response Structure

### Status Code

- `4xx`: Client errors

- `5xx`: Server errors

### Body

```json
{
    // Custom result code
    "code": 500	// 4xx: Client errors. 5xx: Server errors
    "Message": "PlayerManager.refresh.invalidRefreshToken" // Error message's I18N path
    "Reason": "Redis connection lost" // Internal reasons (Maybe empty)
}
```

## Result Code List

```c++
enum class ResultCode : uint32_t {
    // Message codes (100 ~ 199)

    // Success codes (200 ~ 299)
    Completed = 200,
    Continued = 201,

    // Failed codes (400 ~ 499)
    InvalidFormat = 400,
    InvalidArguments = 401,
    NotAvailable = 402,
    NoPermission = 403,
    NotFound = 404,
    NullValue = 405,
    NotAcceptable = 406,
    Conflict = 409,
    TooFrequent = 429,

    // Error codes (500 ~ 599)
    InternalError = 500,
    DatabaseError = 501,
    EmailError = 502,
};
```

## API Group: `Auth`

### /check

#### Description

Check if the access token is valid and return related player ID

#### Request

##### Method

Get

##### Headers

- x-access-token: Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

None

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200
}
```

### /refresh

#### Description

Check if the refresh token is valid, renew TTL of refresh token, then return a newly generated access token along with the refresh token

#### Request

##### Method

Get

##### Headers

- x-refresh-token: Refresh token retrieved by `/login` methods

##### Body

None

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200,
    "data": {
        "refreshToken": "XXXXXXXXXXXXX",
        "accessToken": "XXXXXXXXXXXXX"
    }
}
```

### /verify/email

#### Description

Send verification code to the specified email. Has frequency limits on `email` and `ip` 

#### Request

##### Method

Post

##### Headers

None

##### Body

```json
{
    "email": "xxxxx@xxx.xxx"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200,
}
```

### /seed/email

#### Description

Generate random seed according to the specified email. Should be used to hash player's login password

#### Request

##### Method

Post

##### Headers

None

##### Body

```json
{
    "email": "xxxxx@xxx.xxx"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200,
    "data": "XXXXXXXXXXXXXXXXXX" // Hex string
}
```

### /login/email

#### Description

Login with email & password hash or email & verification code

#### Request

##### Method

Post

##### Headers

None

##### Body

```json
{
    "email": "xxxxx@xxx.xxx",
    "code": "XXXXXXXX", // Optional. Either specify this or 'password'
    "password": "XXXXXXXXXXXXXX" // Optional. Either specify this or 'code'
}
```

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200, // 200: Successfully logged in. 201: Successfully created account, need to update info and password
    "data": {
        "refreshToken": "XXXXXXXXXXXXX",
        "accessToken": "XXXXXXXXXXXXX"
    }
}
```

### /reset/email

#### Description

Use email & verification code to reset player's password hash

#### Request

##### Method

Put

##### Headers

None

##### Body

```json
{
    "email": "xxxxx@xxx.xxx",
    "code": "XXXXXXXX",
    "newPassword": "XXXXXXXXXXXXXX"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200
}
```

### /migrate/email

#### Description

Validate new email with verification code. Need to be logged in first (Require access token)

#### Request

##### Method

Put

##### Headers

- x-access-token: Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

```json
{
    "newEmail": "xxxxx@xxx.xxx",
    "code": "XXXXXXXX"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200
}
```

### /deactivate/email

#### Description

Deactivate current account with verification code. Need to be logged in first (Require access token)

***Warning: This can't be reversed by normal players! If you accidentally deactivated your account, please contact admin.***

#### Request

##### Method

Post

##### Headers

- x-access-token: Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

```json
{
    "code": "XXXXXXXX"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
    "code": 200
}
```

