# Techrater HTTP API

## Hosts

- `cafuuchino1.3322.org:10026`
- `cafuuchino2.3322.org:10026`
- `cafuuchino3.3322.org:10026`
- `cafuuchino4.3322.org:10026`
- `cafuuchino5.3322.org:10026`

## Base Path

`/techmino/api/v1`

## Failed Response Structure

### Status Code

- `4xx`: Client errors

- `5xx`: Server errors

### Body

```json
{
  // Custom result code. 4xx: Client errors. 5xx: Server errors
  "code": 500,
  // Error message's I18N path
  "Message": "PlayerManager.refresh.invalidRefreshToken",
  // Internal reasons (Optional)
  "Reason": "Redis connection lost"
}
```

## Result Code List

```c++
enum class ResultCode : uint32_t {
    // Message codes (100 ~ 199)

    // Success codes (200 ~ 299)
    Completed = 200,
    Continued = 201,

    // Failed codes (400 ~ 499)
    InvalidFormat = 400,
    InvalidArguments = 401,
    NotAvailable = 402,
    NoPermission = 403,
    NotFound = 404,
    NullValue = 405,
    NotAcceptable = 406,
    Conflict = 409,
    TooFrequent = 429,

    // Error codes (500 ~ 599)
    InternalError = 500,
    DatabaseError = 501,
    EmailError = 502,
};
```

## API Group: `Auth`

### /check

#### Description

Check if the access token is valid and return related player ID.

#### Request

##### Method

Get

##### Headers

- x-access-token: Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

None

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200
}
```

### /refresh

#### Description

Check if the refresh token is valid, renew TTL of refresh token,

then return a newly generated access token along with the refresh token.

#### Request

##### Method

Get

##### Headers

- x-refresh-token: Refresh token retrieved by `/login` methods

##### Body

None

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200,
  "data": {
    "refreshToken": "HEX_STRING",
    "accessToken": "HEX_STRING"
  }
}
```

### /verify/email

#### Description

Send verification code to the specified email. Has frequency limits on `email` and `ip`.

#### Request

##### Method

Post

##### Headers

None

##### Body

```json
{
  "email": "EMAIL_ADDRESS"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200
}
```

### /seed/email

#### Description

Generate random seed according to the specified email. Should be used to hash player's login password.

#### Request

##### Method

Post

##### Headers

None

##### Body

```json
{
  "email": "EMAIL_ADDRESS"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200,
  "data": "HEX_STRING"
}
```

### /login/email

#### Description

Login with email & password hash or email & verification code.

#### Request

##### Method

Post

##### Headers

None

##### Body

```json
{
  "email": "EMAIL_ADDRESS",
  // Optional. Either specify 'code' or 'password'
  "code": "RANDOM_STRING_LENGTH_8",
  "password": "HASHED_STRING"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
  // 200: Successfully logged in. 201: Successfully created account, need to update info and password
  "code": 200,
  "data": {
    "refreshToken": "HEX_STRING",
    "accessToken": "HEX_STRING"
  }
}
```

### /reset/email

#### Description

Use email & verification code to reset player's password hash.

#### Request

##### Method

Put

##### Headers

None

##### Body

```json
{
  "email": "EMAIL_ADDRESS",
  "code": "RANDOM_STRING_LENGTH_8",
  "newPassword": "HASHED_STRING"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200
}
```

### /migrate/email

#### Description

Validate new email with verification code. Need to be logged in first (Require access token).

#### Request

##### Method

Put

##### Headers

- x-access-token: Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

```json
{
  "newEmail": "EMAIL_ADDRESS",
  "code": "RANDOM_STRING_LENGTH_8"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200
}
```

### /deactivate/email

#### Description

Deactivate current account with verification code. Need to be logged in first (Require access token).

***Warning: This can't be reversed by normal players! If you accidentally deactivated your account, please contact
admin.***

#### Request

##### Method

Post

##### Headers

- x-access-token: Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

```json
{
  "code": "RANDOM_STRING_LENGTH_8"
}
```

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200
}
```

## API Group: `Player`

### /avatar?id={playerID (Optional)}

#### Description

Get avatar image specified with player ID or access token.
If `x-access-token` is specified, this would return request sender's avatar.
Otherwise, this would return the avatar of the player specified by `playerId`

#### Request

##### Method

Get

##### Headers

- x-access-token: (Optional) Access token retrieved by `/login` methods, or generated by `/refresh` method

##### Body

None

#### Response

##### Status Code

200

##### Body

```json
{
  "code": 200,
  "data": "BASE64_STRING"
}
```

### /info?id={playerID (Optional in `Get`. Drop in `Put`)}

#### Description

- Get player's info specified with player ID or access token.
  If `x-access-token` is specified, this would return request sender's *full* info.
  Otherwise, this would return the *brief* info of the player specified by `playerId`
- Update player info. Need to be logged in first (Require access token).

#### Request

##### Method

- Get
- Put

##### Headers

- x-access-token: (Optional in `Get`. Required in `Put`) Access token retrieved by `/login` methods,
  or generated by `/refresh` method

##### Body

- Get: None
- Put:

```json
{
  "username": "Tester",
  "motto": "Techrater is awesome",
  "region": 1,
  "avatar": "BASE64_STRING",
  "avatar_frame": 12,
  "clan": "Miya fan club",
  "password": "HASHED_STRING"
}
```

#### Response

##### Status Code

200

##### Body

```json
// Get
{
  "code": 200,
  "data": {
    "id": 1,
    "username": "user",
    "motto": "Techmino is fun!",
    "region": 0,
    "avatar_hash": "BASE64_STRING",
    "avatar_frame": 0,
    "clan": "",
    "permission": "Normal",
    // Below is not included if accessing other player's info
    "email": "user@example.com",
    "phone": "123-456-7890"
  }
}

// Put
{
  "code": 200
}
```

### /data?id={playerID (Optional in `Get`. Drop in `Put`)}

#### Description

- Get player's data specified with player ID or access token.
  If `x-access-token` is specified, this would return request sender's *full* data.
  Otherwise, this would return the *brief* data of the player specified by `playerId`
- Update player data. Need to be logged in first (Require access token).

#### Request

##### Method

- Get
- Put

##### Headers

- x-access-token: (Optional in `Get`. Required in `Put`) Access token retrieved by `/login` methods,
  or generated by `/refresh` method

##### Body

- Get: None
- Put:

```json
{
  "statistics": "ANY_STRING",
  "ranks": "ANY_STRING",
  "settings": "ANY_STRING",
  "keymaps": "ANY_STRING",
  "touch_1": "ANY_STRING",
  "touch_2": "ANY_STRING",
  "touch_3": "ANY_STRING",
  "extra_1": "ANY_STRING",
  "extra_2": "ANY_STRING",
  "extra_3": "ANY_STRING"
}
```

#### Response

##### Status Code

200

##### Body

```json
// Get
{
  "code": 200,
  "data": {
    "id": 1,
    "statistics": "ANY_STRING",
    "ranks": "ANY_STRING",
    "extra_1": "ANY_STRING",
    "extra_2": "ANY_STRING",
    "extra_3": "ANY_STRING",
    // Below is not included if accessing other player's info
    "settings": "ANY_STRING",
    "keymaps": "ANY_STRING",
    "touch_1": "ANY_STRING",
    "touch_2": "ANY_STRING",
    "touch_3": "ANY_STRING"
  }
}

// Put
{
  "code": 200
}
```